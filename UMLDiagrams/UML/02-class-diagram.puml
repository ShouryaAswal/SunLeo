@startuml
skinparam classAttributeIconSize 0

class ApiService {
  -jobs: Dict[str, JobRecord]
  -queue: InMemoryJobQueue
  -downloadDir: Path
  +healthz(): dict
  +search(query: str): list
  +convert(request: ConvertRequest): ConvertResponse
  +status(jobId: str): StatusResponse
  +download(jobId: str): FileResponse
  +recommend(userSongs: list): list
  -processJob(jobId: str): void
}

class InMemoryJobQueue {
  -_queue: asyncio.Queue[str]
  -_workerTask: asyncio.Task
  -_worker: Callable
  -_running: bool
  +enqueue(jobId: str): void
  +start(worker: Callable): void
  +stop(): void
  -run(): void
}

class ConverterService {
  +convertYouTubeToMp3(url: str, outputDir: Path): (Path, str?, str)
}

class SearchService {
  +searchYouTube(query: str): list
  -buildQuery(query: str): dict
}

class YouTubeApiClient {
  +search(queryParams: dict): list
  #rateLimit(): void
}

class RecommendationService {
  -scaler: StandardScaler
  -features: list
  +recommend(userSongs: list, topN: int): list
  #computeSimilarity(userRows: list): list
}

class DatasetRepository {
  -path: str
  +load(): list
}

class YouTubeUrlUtils {
  +extractVideoId(url: str): str?
  +validateUrl(url: str): bool
}

class JobRecord {
  +jobId: str
  +url: str
  +videoId: str
  +status: JobStatus
  +title: str?
  +filePath: str?
  +error: str?
  +createdAt: datetime
  +startedAt: datetime?
  +finishedAt: datetime?
}

enum JobStatus {
  queued
  running
  completed
  failed
}

class ConvertRequest {
  +youtubeUrl: str
}

class ConvertResponse {
  +jobId: str
  +status: JobStatus
}

class StatusResponse {
  +jobId: str
  +status: JobStatus
  +title: str?
  +error: str?
  +downloadUrl: str?
}

ApiService "1" *-- "1" InMemoryJobQueue : owns
ApiService "1" o-- "0..*" JobRecord : manages
ApiService ..> ConverterService : uses
ApiService ..> YouTubeUrlUtils : validates
ApiService ..> SearchService : uses
ApiService ..> RecommendationService : uses
ApiService ..> ConvertRequest
ApiService ..> ConvertResponse
ApiService ..> StatusResponse
JobRecord --> JobStatus
ConvertResponse --> JobStatus
StatusResponse --> JobStatus
SearchService "1" --> "1" YouTubeApiClient : uses
RecommendationService "1" o-- "1" DatasetRepository : reads

@enduml
